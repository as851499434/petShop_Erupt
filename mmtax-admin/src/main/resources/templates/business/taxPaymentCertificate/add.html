<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('新增完税证明')"/>
    <style>
        .table-striped{
            height: 300px;
            overflow-y: scroll;
        }
        /* 设置滚动条的样式 */
        ::-webkit-scrollbar {
            width:12px;
        }

        /* 滚动槽 */
        ::-webkit-scrollbar-track {
            border-radius:10px;
        }

        /* 滚动条滑块 */
        ::-webkit-scrollbar-thumb {
            border-radius:10px;
            background:#e8e8e8;
        }
    </style>
</head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-taxPaymentCertificate-add">
        <div class="form-group">
            <label class="col-sm-3 control-label">文件名称：</label>
            <div class="col-sm-8">
                <input name="name" class="form-control" type="text">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">商户名称：</label>
            <div class="col-sm-8">
                <a data-toggle="modal" data-target="#myModal" class="btn btn-success">选择商户</a>
                <span id="name"></span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">文件上传：</label>
            <div class="col-sm-8">
                <input type="file" id="file" onchange="filechange(event)" style="display: none" accept=".doc,.pdf,.docx"/>
                <a href="javascript:onBanner()" class="btn btn-danger">选择文件</a>
                <span id="filename"></span>
            </div>
        </div>
    </form>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="width: 420px;height: 380px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">选择商户</h4>
            </div>
            <form class="form-horizontal m" id="form-add">
                <div class="form-group">
                    <label class="col-sm-3 control-label">商户名称：</label>
                    <div class="col-sm-8">
                        <input name="merchantName" class="form-control" type="text">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-3 control-label">商户编码：</label>
                    <div class="col-sm-8">
                        <input name="merchantCode" class="form-control" type="text">
                    </div>
                </div>
                <div class="form-group">
                    <div style="margin-left:10%;">
                        <a class="btn btn-primary btn-rounded btn-sm" onclick="searchname()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                    </div>
                </div>
            </form>
            <div class="col-sm-12 select-table table-striped" style="height: 300px;">
                <table cellspacing="0" border="5px" solid #F00 style="margin: 0 auto;" id="content">
                    <!--<tr>-->
                        <!--<th th:width="200" height="50" style="text-align: center;"></th>-->
                        <!--<th th:width="200" style="text-align: center;">商户名称</th>-->
                        <!--<th th:width="200" style="text-align: center;">商户编码</th>-->
                    <!--</tr>-->
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="enable()">确定</button>
            </div>
        </div>
    </div>
</div>
<div th:include="include::footer"></div>
<script type="text/javascript">
    var resFileURL = ""
    var arr = []
    function searchname () {
        $("#content").text("")
        var html = '<tr><th width="200" height="50" style="text-align: center;"></th><th width="200" style="text-align: center;">商户名称</th><th width="200" style="text-align: center;">商户编码</th></tr>'
        var currentPage = 1
        var merchantCode = $("input[name='merchantCode']").val()
        var merchantName = $("input[name='merchantName']").val()
        $.get("/manager/taxPaymentCertificate/getMerchantInfo?currentPage="+currentPage+"&merchantCode="+merchantCode+"&merchantName="+merchantName+"&pageSize=10",function (data) {
            arr = data.data.data
            if(data.code == 0) {
                data.data.data.forEach(function (item) {
                    html+='<tr>'
                    html+='<td style="text-align: center;" height="50" class="merchantId"><input type="radio" onchange="checkedMer('+item.merchantId+')" name="merchantId" value="'+item.merchantId+'" /></td>'
                    html+='<td th:width="200" style="text-align: center;" class="merchantName">'+item.merchantName+'</td>'
                    html+='<td th:width="200" style="text-align: center;" class="merchantCode">'+item.merchantCode+'</td>'
                    html+='</tr>'
                })
            }
            $("#content").append(html)
        })
    }
    searchname()
    var merchant = {}
    function checkedMer(ids) {
        arr.forEach(function (item) {
            if(ids == item.merchantId){
                merchant = item
            }
        })
    }
    function enable() {
        $("#name").text(merchant.merchantName)
    }
    var fileUrl;  //需要的url，在保存时后台需要这个地址
    var saveFileName;  //上传完成后截取的文件名
    var files;
    var option ={
        fileUrl: ""
    }
    function onBanner() {
        $("#file").click();
    }
    var filechange=function(event){
        files = event.target.files, file;
        if (files && files.length > 0) {
            file = files[0];
            if(file.size > 1024 * 1024 * 10) {
                alert('文件大小不能超过 10MB!');
                return false;
            }
            var reader = new FileReader();
            reader.onload = function(e) {
                fileUrl = e.target.result;
                if((file.type).indexOf("pdf")==-1){
                    $.modal.alertWarning("文件格式错误，请上传文件类型,如：pdf后缀的文件。");
                } else {
                    option.fileUrl = fileUrl
                }
            }
            $("#filename").text(file.name);
            reader.readAsDataURL(file);
        }
    };
    function getBlob()
    {
        var url = option.fileUrl;

        if(url!="") {
            if(url.indexOf("data:")==0) {
                var b64 = url.replace('data:application/pdf;', '');
            }
            return file;
        }
    }
    function submitHandler() {
        var url = getBlob()
        var formdata = new FormData();
        formdata.append("file", url);
        $.ajax({
            url: ctx + "common/upload",
            data: formdata,
            type: "post",
            processData: false,
            contentType: false,
            success: function(result) {
                resFileURL = result.url
                var merchantId = merchant.merchantId
                // var fileName = result.fileNam
                var name = $("input[name='name']").val()
                var params = {
                    merchantId:merchantId,
                    name:name,
                    fileName:result.fileName
                }
                if(name == undefined||name == ''){
                    $.modal.msgWarning("请输入文件名称")
                    return
                }
                if(merchantId == undefined||merchantId == ''){
                    $.modal.msgWarning("请选中商户")
                    return
                }
                if(result.fileName == undefined||result.fileName == ''){
                    $.modal.msgWarning("请选择上传的文件")
                    return
                }
                params = JSON.stringify(params)
                $.ajax({
                    url: "/manager/taxPaymentCertificate/add",
                    data: params,
                    type: "post",
                    processData: false,
                    contentType: "application/json",
                    beforeSend: function () {
                        $.modal.loading("正在处理中，请稍后...");
                        $.modal.disable();
                    },
                    success: function(result) {
                        if (typeof callback == "function") {
                            callback(result);
                        }
                        $.operate.successCallback(result);
                    }
                })
            }
        })
    }
    var prefix = ctx + "business/taxPaymentCertificate"
    $("#form-taxPaymentCertificate-add").validate({
        rules: {
            xxxx: {
                required: true,
            },
        },
        focusCleanup: true
    });

    // function submitHandler() {
    //
    //
    // }
</script>
</body>
</html>
